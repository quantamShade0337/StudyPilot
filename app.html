<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyPilot - Smart Student Hub</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    :root {
      --brand-blue: rgb(99, 102, 241);
      --brand-purple: rgb(168, 85, 247);
      --brand-teal: rgb(20, 184, 166);
      --bg: #05070b;
      --surface: rgba(255, 255, 255, 0.06);
      --border: rgba(255, 255, 255, 0.12);
      --text: rgba(255, 255, 255, 0.92);
      --muted: rgba(255, 255, 255, 0.70);
      --muted-2: rgba(255, 255, 255, 0.55);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }
    
    h1, h2, h3, h4 { font-family: 'Outfit', sans-serif; }
    
    .grid-bg {
      background-image:
        radial-gradient(1200px 800px at 80% 10%, rgba(99,102,241,0.18), transparent 60%),
        radial-gradient(900px 700px at 10% 30%, rgba(168,85,247,0.15), transparent 60%),
        linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
      background-size: auto, auto, 56px 56px, 56px 56px;
    }
    
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: 0 20px 80px rgba(0,0,0,0.55);
      backdrop-filter: blur(14px);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 25px 90px rgba(0,0,0,0.65);
      border-color: rgba(255,255,255,0.18);
    }
    
    .btn {
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
    }
    
    .btn:active { transform: translateY(1px) scale(0.99); }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple));
      color: white;
      box-shadow: 0 10px 30px rgba(99,102,241,0.25);
    }
    
    .btn-primary:hover {
      box-shadow: 0 15px 40px rgba(99,102,241,0.35);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--text);
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,0.12);
      border-color: rgba(255,255,255,0.22);
    }
    
    .btn-success {
      background: linear-gradient(135deg, rgb(16, 185, 129), rgb(20, 184, 166));
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, rgb(239, 68, 68), rgb(220, 38, 38));
      color: white;
    }
    
    .input, select.input, textarea.input {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 12px;
      color: var(--text);
      outline: none;
      padding: 12px 16px;
      font-size: 14px;
      width: 100%;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    
    .input:focus, select.input:focus, textarea.input:focus {
      border-color: rgba(99,102,241,0.55);
      box-shadow: 0 0 0 4px rgba(99,102,241,0.15);
    }
    
    .input::placeholder { color: var(--muted-2); }
    
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      width: 300px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-right: 1px solid var(--border);
      backdrop-filter: blur(20px);
      z-index: 100;
      overflow-y: auto;
      padding: 24px;
    }
    
    .sidebar-item {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 8px;
      padding: 16px 12px;
      border-radius: 12px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 8px;
      font-weight: 600;
      text-align: center;
    }
    
    .sidebar-item:hover {
      background: rgba(255,255,255,0.08);
      color: var(--text);
    }
    
    .sidebar-item.active {
      background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.15));
      color: var(--text);
      border: 1px solid rgba(99,102,241,0.25);
    }
    
    .sidebar-item i {
      width: 24px;
      height: 24px;
    }
    
    .sidebar-item span {
      font-size: 13px;
      white-space: nowrap;
    }
    
    .main-content {
      margin-left: 300px;
      padding: 32px;
      min-height: 100vh;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--brand-blue), var(--brand-purple));
      border-radius: 999px;
      transition: width 0.5s ease;
    }
    
    .timer-display {
      font-size: 48px;
      font-weight: 800;
      font-family: 'Outfit', sans-serif;
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
    }
    
    .task-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      margin-bottom: 10px;
      transition: all 0.2s ease;
    }
    
    .task-item:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.14);
    }
    
    .task-item.completed { opacity: 0.6; }
    .task-item.completed .task-text { text-decoration: line-through; }
    
    .checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .checkbox.checked {
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple));
      border-color: var(--brand-blue);
    }
    
    .page { display: none; animation: fadeIn 0.3s ease; }
    .page.active { display: block; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Authentication Screen */
    .auth-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    
    .auth-screen.hidden {
      display: none;
    }
    
    .auth-container {
      width: 100%;
      max-width: 440px;
      padding: 48px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 24px;
      backdrop-filter: blur(20px) saturate(180%);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }
    
    .auth-logo {
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-family: 'Outfit', sans-serif;
      text-align: center;
      margin-bottom: 12px;
    }
    
    .auth-subtitle {
      text-align: center;
      color: var(--muted);
      margin-bottom: 32px;
      font-size: 15px;
    }
    
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .auth-toggle {
      text-align: center;
      margin-top: 24px;
      color: var(--muted);
      font-size: 14px;
    }
    
    .auth-toggle a {
      color: var(--brand-blue);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }
    
    .auth-toggle a:hover {
      text-decoration: underline;
    }
    
    .auth-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: rgb(252, 165, 165);
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
      display: none;
    }
    
    .auth-error.show {
      display: block;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active { display: flex; }
    
    .modal-content {
      background: linear-gradient(180deg, rgba(20,23,30,0.98), rgba(15,17,22,0.98));
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 32px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 40px 120px rgba(0,0,0,0.8);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .subject-math { background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.3); color: rgb(252, 165, 165); }
    .subject-science { background: rgba(34, 197, 94, 0.15); border-color: rgba(34, 197, 94, 0.3); color: rgb(134, 239, 172); }
    .subject-english { background: rgba(59, 130, 246, 0.15); border-color: rgba(59, 130, 246, 0.3); color: rgb(147, 197, 253); }
    .subject-history { background: rgba(251, 191, 36, 0.15); border-color: rgba(251, 191, 36, 0.3); color: rgb(253, 224, 71); }
    .subject-art { background: rgba(168, 85, 247, 0.15); border-color: rgba(168, 85, 247, 0.3); color: rgb(216, 180, 254); }
    .subject-other { background: rgba(20, 184, 166, 0.15); border-color: rgba(20, 184, 166, 0.3); color: rgb(94, 234, 212); }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    
    .empty-state i {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 4px; }
    
    @media (max-width: 768px) {
      .sidebar { width: 80px; padding: 16px 8px; }
      .sidebar-item { padding: 12px 8px; }
      .sidebar-item span { font-size: 10px; }
      .main-content { margin-left: 80px; padding: 20px; }
    }
    
    .delete-btn {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: rgb(252, 165, 165);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
    }
    
    .delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
    }
  </style>
</head>
<body class="grid-bg">
  
  <!-- Authentication Screen -->
  <div id="authScreen" class="auth-screen">
    <div class="auth-container">
      <div class="auth-logo">StudyPilot</div>
      <p class="auth-subtitle">Your Smart Study Companion</p>
      
      <div id="authError" class="auth-error"></div>
      
      <!-- Login Form -->
      <div id="loginForm">
        <form class="auth-form" onsubmit="handleLogin(event)">
          <input type="email" id="loginEmail" class="input" placeholder="Email" required autocomplete="email">
          <input type="password" id="loginPassword" class="input" placeholder="Password" required autocomplete="current-password">
          <button type="submit" class="btn btn-primary" style="width: 100%;">
            <span id="loginBtnText">Sign In</span>
          </button>
        </form>
        <div class="auth-toggle">
          Don't have an account? <a onclick="showSignup()">Sign up</a>
        </div>
      </div>
      
      <!-- Signup Form -->
      <div id="signupForm" style="display: none;">
        <form class="auth-form" onsubmit="handleSignup(event)">
          <input type="email" id="signupEmail" class="input" placeholder="Email" required autocomplete="email">
          <input type="password" id="signupPassword" class="input" placeholder="Password (min 6 characters)" required minlength="6" autocomplete="new-password">
          <input type="password" id="signupConfirm" class="input" placeholder="Confirm Password" required minlength="6" autocomplete="new-password">
          <button type="submit" class="btn btn-primary" style="width: 100%;">
            <span id="signupBtnText">Create Account</span>
          </button>
        </form>
        <div class="auth-toggle">
          Already have an account? <a onclick="showLogin()">Sign in</a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sidebar -->
  <div class="sidebar">
    <div style="margin-bottom: 32px; text-align: center;">
      <h1 class="text-2xl font-extrabold" style="background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
        StudyPilot
      </h1>
      <p class="text-sm" style="color: var(--muted-2); margin-top: 4px;">Smart Student Hub</p>
    </div>
    
    <nav id="sidebarNav">
      <div style="padding: 0 16px 12px; margin-bottom: 8px; text-align: center;">
        <span style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted-2);">NAVIGATION</span>
      </div>
      
      <div class="sidebar-item active" data-page="dashboard">
        <i data-lucide="layout-dashboard"></i>
        <span>Dashboard</span>
      </div>
      <div class="sidebar-item" data-page="planner">
        <i data-lucide="calendar"></i>
        <span>Planner</span>
      </div>
      <div class="sidebar-item" data-page="study">
        <i data-lucide="book-open"></i>
        <span>Study Tools</span>
      </div>
      <div class="sidebar-item" data-page="progress">
        <i data-lucide="trending-up"></i>
        <span>Progress</span>
      </div>
      <div class="sidebar-item" data-page="goals">
        <i data-lucide="target"></i>
        <span>Goals</span>
      </div>
    </nav>
    
    <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border);">
      <div style="padding: 0 16px 12px; margin-bottom: 8px; text-align: center;">
        <span style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted-2);">ACCOUNT</span>
      </div>
      
      <div class="sidebar-item" data-page="settings">
        <i data-lucide="settings"></i>
        <span>Settings</span>
      </div>
    </div>
  </div>
  
  <!-- Main Content Container -->
  <div class="main-content" id="mainContent"></div>
  
  <!-- Add Task Modal -->
  <div class="modal" id="taskModal">
    <div class="modal-content">
      <h3 class="text-2xl font-bold" style="margin-bottom: 20px;">Add New Task</h3>
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--muted);">Task Title</label>
          <input type="text" class="input" id="taskTitle" placeholder="e.g., Complete Math homework" />
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--muted);">Subject</label>
          <select class="input" id="taskSubject">
            <option>Math</option>
            <option>Science</option>
            <option>English</option>
            <option>History</option>
            <option>Art</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--muted);">Due Date & Time</label>
          <input type="datetime-local" class="input" id="taskDue" />
        </div>
        <div style="display: flex; gap: 12px; margin-top: 12px;">
          <button class="btn btn-primary" style="flex: 1; padding: 12px;" onclick="saveTask()">Add Task</button>
          <button class="btn btn-secondary" style="flex: 1; padding: 12px;" onclick="closeModal('taskModal')">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Exam Modal -->
  <div class="modal" id="examModal">
    <div class="modal-content">
      <h3 class="text-2xl font-bold" style="margin-bottom: 20px;">Add Exam Date</h3>
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--muted);">Exam Name</label>
          <input type="text" class="input" id="examName" placeholder="e.g., Algebra Final Exam" />
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--muted);">Subject</label>
          <select class="input" id="examSubject">
            <option>Math</option>
            <option>Science</option>
            <option>English</option>
            <option>History</option>
            <option>Art</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--muted);">Exam Date & Time</label>
          <input type="datetime-local" class="input" id="examDate" />
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--muted);">Notes (Optional)</label>
          <textarea class="input" id="examNotes" rows="3" placeholder="e.g., Chapters 1-5, bring calculator"></textarea>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 12px;">
          <button class="btn btn-primary" style="flex: 1; padding: 12px;" onclick="saveExam()">Add Exam</button>
          <button class="btn btn-secondary" style="flex: 1; padding: 12px;" onclick="closeModal('examModal')">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Goal Modal -->
  <div class="modal" id="goalModal">
    <div class="modal-content">
      <h3 class="text-2xl font-bold" style="margin-bottom: 20px;">Create New Goal</h3>
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--muted);">Goal Title</label>
          <input type="text" class="input" id="goalTitle" placeholder="e.g., Study 4 hours daily" />
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--muted);">Category</label>
          <select class="input" id="goalCategory">
            <option>Study Time</option>
            <option>Grade Target</option>
            <option>Habit Building</option>
            <option>Skill Development</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--muted);">Target Date</label>
          <input type="date" class="input" id="goalTarget" />
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--muted);">Description</label>
          <textarea class="input" id="goalDescription" rows="3" placeholder="Describe your goal..."></textarea>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 12px;">
          <button class="btn btn-primary" style="flex: 1; padding: 12px;" onclick="saveGoal()">Create Goal</button>
          <button class="btn btn-secondary" style="flex: 1; padding: 12px;" onclick="closeModal('goalModal')">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Custom Timer Modal -->
  <div class="modal" id="customTimerModal">
    <div class="modal-content">
      <h3 class="text-2xl font-bold" style="margin-bottom: 20px;">Set Custom Timer</h3>
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--muted);">Minutes</label>
          <input type="number" class="input" id="customMinutes" placeholder="e.g., 30" min="1" max="180" value="30" />
        </div>
        <div style="display: flex; gap: 12px; margin-top: 12px;">
          <button class="btn btn-primary" style="flex: 1; padding: 12px;" onclick="setCustomTimer()">Set Timer</button>
          <button class="btn btn-secondary" style="flex: 1; padding: 12px;" onclick="closeModal('customTimerModal')">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    // ========================================
    // SECURITY & VALIDATION
    // ========================================
    
    // Sanitize user input to prevent XSS attacks
    function sanitizeInput(input) {
      if (typeof input !== 'string') return input;
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }
    
    // Validate email format
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }
    
    // Validate data before saving
    function validateTaskData(task) {
      if (!task.text || typeof task.text !== 'string') return false;
      if (task.text.length > 500) return false; // Prevent excessive data
      return true;
    }
    
    function validateExamData(exam) {
      if (!exam.name || typeof exam.name !== 'string') return false;
      if (exam.name.length > 200) return false;
      if (!exam.subject || typeof exam.subject !== 'string') return false;
      if (!exam.date) return false;
      return true;
    }
    
    function validateGoalData(goal) {
      if (!goal.title || typeof goal.title !== 'string') return false;
      if (goal.title.length > 200) return false;
      if (!goal.category || typeof goal.category !== 'string') return false;
      return true;
    }
    
    // ========================================
    // FIREBASE CONFIGURATION
    // ========================================
    // PASTE YOUR FIREBASE CONFIG HERE:
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    
    let currentUser = null;
    
    // ========================================
    // AUTHENTICATION FUNCTIONS
    // ========================================
    
    // Check if user is logged in
    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        document.getElementById('authScreen').classList.add('hidden');
        loadUserData();
      } else {
        currentUser = null;
        document.getElementById('authScreen').classList.remove('hidden');
      }
    });
    
    // Show/Hide Forms
    function showLogin() {
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('signupForm').style.display = 'none';
      hideError();
    }
    
    function showSignup() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = 'block';
      hideError();
    }
    
    // Error Handling
    function showError(message) {
      const errorEl = document.getElementById('authError');
      errorEl.textContent = message;
      errorEl.classList.add('show');
    }
    
    function hideError() {
      const errorEl = document.getElementById('authError');
      errorEl.classList.remove('show');
    }
    
    // Handle Login
    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtnText');
      
      try {
        btn.textContent = 'Signing in...';
        hideError();
        await auth.signInWithEmailAndPassword(email, password);
        // User will be redirected by onAuthStateChanged
      } catch (error) {
        console.error('Login error:', error);
        showError(getErrorMessage(error.code));
        btn.textContent = 'Sign In';
      }
    }
    
    // Handle Signup
    async function handleSignup(e) {
      e.preventDefault();
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const confirm = document.getElementById('signupConfirm').value;
      const btn = document.getElementById('signupBtnText');
      
      if (password !== confirm) {
        showError('Passwords do not match');
        return;
      }
      
      try {
        btn.textContent = 'Creating account...';
        hideError();
        await auth.createUserWithEmailAndPassword(email, password);
        // User will be redirected by onAuthStateChanged
      } catch (error) {
        console.error('Signup error:', error);
        showError(getErrorMessage(error.code));
        btn.textContent = 'Create Account';
      }
    }
    
    // Handle Logout
    function handleLogout() {
      if (confirm('Are you sure you want to log out?')) {
        auth.signOut();
      }
    }
    
    // Get user-friendly error messages
    function getErrorMessage(code) {
      const messages = {
        'auth/email-already-in-use': 'This email is already registered',
        'auth/invalid-email': 'Invalid email address',
        'auth/weak-password': 'Password should be at least 6 characters',
        'auth/user-not-found': 'No account found with this email',
        'auth/wrong-password': 'Incorrect password',
        'auth/too-many-requests': 'Too many attempts. Please try again later',
        'auth/network-request-failed': 'Network error. Check your connection'
      };
      return messages[code] || 'An error occurred. Please try again';
    }
    
    // ========================================
    // FIREBASE DATABASE SYNC
    // ========================================
    
    // Load user data from Firebase
    function loadUserData() {
      if (!currentUser) return;
      
      const userRef = database.ref('users/' + currentUser.uid);
      userRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          state.tasks = data.tasks || [];
          state.exams = data.exams || [];
          state.goals = data.goals || [];
          state.studyTime = data.studyTime || 0;
          state.streak = data.streak || 0;
          state.lastStudyDate = data.lastStudyDate || null;
        }
        
        // Check and update streak
        checkStreak();
        
        // Navigate to dashboard after loading data
        navigate('dashboard');
        lucide.createIcons();
      });
    }
    
    // Save state to Firebase (replaces localStorage)
    function saveState() {
      if (!currentUser) return;
      
      const userRef = database.ref('users/' + currentUser.uid);
      userRef.set({
        tasks: state.tasks,
        exams: state.exams,
        goals: state.goals,
        studyTime: state.studyTime,
        streak: state.streak,
        lastStudyDate: state.lastStudyDate,
        lastUpdated: Date.now()
      }).catch(error => {
        console.error('Error saving data:', error);
      });
    }
    
    // ========================================
    // APP STATE
    // ========================================
    // App State with localStorage
    const state = {
      currentPage: 'dashboard',
      timer: { minutes: 25, seconds: 0, isRunning: false, interval: null },
      tasks: [],
      exams: [],
      goals: [],
      studyTime: 0,
      streak: 0,
      lastStudyDate: null
    };
    
    function formatDateTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = date - now;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      
      if (days < 0) return 'Overdue';
      if (days === 0 && hours < 24) return 'Today';
      if (days === 1) return 'Tomorrow';
      if (days < 7) return `${days} days`;
      return date.toLocaleDateString();
    }
    
    function getCompletedTasksCount() {
      return state.tasks.filter(t => t.completed).length;
    }
    
    function getTotalTasksCount() {
      return state.tasks.length;
    }
    
    function getUpcomingExams() {
      const now = new Date();
      return state.exams
        .filter(e => new Date(e.date) > now)
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 3);
    }
    
    // Page Templates
    const pages = {
      dashboard: () => `
        <div>
          <div style="margin-bottom: 32px;">
            <h2 class="text-3xl font-extrabold">Dashboard</h2>
            <p class="text-lg" style="color: var(--muted); margin-top: 8px;">Welcome back! Here's your overview</p>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px;">
            <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border-color: rgba(99,102,241,0.2);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <span style="color: var(--muted); font-size: 14px; font-weight: 600;">Study Streak</span>
                <i data-lucide="flame" class="w-5 h-5" style="color: rgb(251, 146, 60);"></i>
              </div>
              <div style="font-size: 36px; font-weight: 800; font-family: 'Outfit', sans-serif; background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">${state.streak}</div>
              <p style="color: var(--muted-2); font-size: 13px; margin-top: 4px;">days in a row</p>
            </div>
            
            <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border-color: rgba(99,102,241,0.2);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <span style="color: var(--muted); font-size: 14px; font-weight: 600;">Tasks Progress</span>
                <i data-lucide="target" class="w-5 h-5" style="color: rgb(34, 197, 94);"></i>
              </div>
              <div style="font-size: 36px; font-weight: 800; font-family: 'Outfit', sans-serif; background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;"><span id="completedCount">${getCompletedTasksCount()}</span>/${getTotalTasksCount()}</div>
              <p style="color: var(--muted-2); font-size: 13px; margin-top: 4px;">completed</p>
            </div>
            
            <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border-color: rgba(99,102,241,0.2);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <span style="color: var(--muted); font-size: 14px; font-weight: 600;">Total Study Time</span>
                <i data-lucide="clock" class="w-5 h-5" style="color: rgb(99, 102, 241);"></i>
              </div>
              <div style="font-size: 36px; font-weight: 800; font-family: 'Outfit', sans-serif; background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">${Math.floor(state.studyTime / 60)}h ${state.studyTime % 60}m</div>
              <p style="color: var(--muted-2); font-size: 13px; margin-top: 4px;">all time</p>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="card" style="padding: 24px;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                <h3 class="text-xl font-bold">My Tasks</h3>
                <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="openModal('taskModal')">
                  <i data-lucide="plus" class="w-4 h-4" style="display: inline-block; vertical-align: middle;"></i>
                  <span style="vertical-align: middle; margin-left: 4px;">Add Task</span>
                </button>
              </div>
              <div id="taskList"></div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 24px;">
              <div class="card" style="padding: 24px;">
                <h3 class="text-lg font-bold" style="margin-bottom: 20px;">Study Timer</h3>
                <div class="timer-display" id="timerDisplay">25:00</div>
                <div style="margin-top: 20px; display: flex; gap: 12px;">
                  <button class="btn btn-success" style="flex: 1; padding: 12px;" id="startTimer" onclick="toggleTimer()">
                    <i data-lucide="play" class="w-4 h-4" style="display: inline-block; vertical-align: middle;"></i>
                    <span style="vertical-align: middle; margin-left: 4px;">Start</span>
                  </button>
                  <button class="btn btn-secondary" style="padding: 12px;" onclick="resetTimer()">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                  </button>
                </div>
                <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: center;">
                  <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="setTimer(25)">25m</button>
                  <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="setTimer(15)">15m</button>
                  <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="setTimer(5)">5m</button>
                </div>
              </div>
              
              <div class="card" style="padding: 24px;">
                <h3 class="text-lg font-bold" style="margin-bottom: 16px;">Upcoming Exams</h3>
                <div id="upcomingExams"></div>
              </div>
            </div>
          </div>
        </div>
      `,
      
      planner: () => `
        <div>
          <div style="margin-bottom: 32px;">
            <h2 class="text-3xl font-extrabold">Planner</h2>
            <p class="text-lg" style="color: var(--muted); margin-top: 8px;">Organize your exams and deadlines</p>
          </div>
          
          <div class="card" style="padding: 24px; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
              <h3 class="text-xl font-bold">Exam Schedule</h3>
              <button class="btn btn-primary" style="padding: 10px 20px; font-size: 14px;" onclick="openModal('examModal')">
                <i data-lucide="plus" class="w-4 h-4" style="display: inline-block; vertical-align: middle;"></i>
                <span style="vertical-align: middle; margin-left: 4px;">Add Exam</span>
              </button>
            </div>
            <div id="examList"></div>
          </div>
        </div>
      `,
      
      study: () => `
        <div>
          <div style="margin-bottom: 32px;">
            <h2 class="text-3xl font-extrabold">Study Tools</h2>
            <p class="text-lg" style="color: var(--muted); margin-top: 8px;">Focus and track your study sessions</p>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="card" style="padding: 32px; text-align: center;">
              <i data-lucide="timer" class="w-12 h-12" style="color: var(--brand-blue); margin: 0 auto;"></i>
              <h3 class="text-2xl font-bold" style="margin: 20px 0 12px;">Pomodoro Timer</h3>
              <p style="color: var(--muted); margin-bottom: 24px;">Focus with time-tested technique</p>
              <div class="timer-display" style="font-size: 64px; margin-bottom: 24px;" id="timerDisplay2">25:00</div>
              <div style="display: flex; gap: 12px; justify-content: center; margin-bottom: 16px;">
                <button class="btn btn-success" style="padding: 14px 28px;" onclick="toggleTimer()">
                  <i data-lucide="play" class="w-5 h-5" style="display: inline-block; vertical-align: middle;"></i>
                  <span style="vertical-align: middle; margin-left: 6px;">Start</span>
                </button>
                <button class="btn btn-secondary" style="padding: 14px;" onclick="resetTimer()">
                  <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                </button>
              </div>
              <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="setTimer(25)">25 min</button>
                <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="setTimer(15)">15 min</button>
                <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="setTimer(5)">5 min</button>
                <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="openCustomTimer()">Custom</button>
              </div>
            </div>
            
            <div class="card" style="padding: 32px;">
              <h3 class="text-xl font-bold" style="margin-bottom: 20px;">Session Stats</h3>
              <div style="display: flex; flex-direction: column; gap: 24px;">
                <div>
                  <div style="font-size: 13px; color: var(--muted); margin-bottom: 8px;">Total Study Time</div>
                  <div style="font-size: 28px; font-weight: 800; font-family: 'Outfit', sans-serif;">${Math.floor(state.studyTime / 60)}h ${state.studyTime % 60}m</div>
                </div>
                <div>
                  <div style="font-size: 13px; color: var(--muted); margin-bottom: 8px;">Current Streak</div>
                  <div style="font-size: 28px; font-weight: 800; font-family: 'Outfit', sans-serif;">${state.streak} days</div>
                </div>
                <div>
                  <div style="font-size: 13px; color: var(--muted); margin-bottom: 8px;">Tasks Completed</div>
                  <div style="font-size: 28px; font-weight: 800; font-family: 'Outfit', sans-serif;">${getCompletedTasksCount()} / ${getTotalTasksCount()}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `,
      
      progress: () => `
        <div>
          <div style="margin-bottom: 32px;">
            <h2 class="text-3xl font-extrabold">Progress</h2>
            <p class="text-lg" style="color: var(--muted); margin-top: 8px;">Track your achievements</p>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 32px;">
            <div class="card" style="padding: 24px; background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border-color: rgba(99,102,241,0.2);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <span style="color: var(--muted); font-size: 14px; font-weight: 600;">Total Study Time</span>
                <i data-lucide="clock" class="w-5 h-5"></i>
              </div>
              <div style="font-size: 32px; font-weight: 800; font-family: 'Outfit', sans-serif; background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">${Math.floor(state.studyTime / 60)}h ${state.studyTime % 60}m</div>
              <p style="color: var(--muted-2); font-size: 13px; margin-top: 8px;">All time</p>
            </div>
            
            <div class="card" style="padding: 24px; background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border-color: rgba(99,102,241,0.2);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <span style="color: var(--muted); font-size: 14px; font-weight: 600;">Tasks Completed</span>
                <i data-lucide="check-circle" class="w-5 h-5"></i>
              </div>
              <div style="font-size: 32px; font-weight: 800; font-family: 'Outfit', sans-serif; background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">${getCompletedTasksCount()}</div>
              <p style="color: var(--muted-2); font-size: 13px; margin-top: 8px;">Total completed</p>
            </div>
            
            <div class="card" style="padding: 24px; background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border-color: rgba(99,102,241,0.2);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <span style="color: var(--muted); font-size: 14px; font-weight: 600;">Study Streak</span>
                <i data-lucide="flame" class="w-5 h-5"></i>
              </div>
              <div style="font-size: 32px; font-weight: 800; font-family: 'Outfit', sans-serif; background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">${state.streak}</div>
              <p style="color: var(--muted-2); font-size: 13px; margin-top: 8px;">Days in a row</p>
            </div>
            
            <div class="card" style="padding: 24px; background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border-color: rgba(99,102,241,0.2);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <span style="color: var(--muted); font-size: 14px; font-weight: 600;">Active Goals</span>
                <i data-lucide="target" class="w-5 h-5"></i>
              </div>
              <div style="font-size: 32px; font-weight: 800; font-family: 'Outfit', sans-serif; background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">${state.goals.length}</div>
              <p style="color: var(--muted-2); font-size: 13px; margin-top: 8px;">Goals set</p>
            </div>
          </div>
          
          <div class="card" style="padding: 24px;">
            <h3 class="text-xl font-bold" style="margin-bottom: 20px;">Task Completion Rate</h3>
            <div class="progress-bar" style="height: 12px; margin-bottom: 12px;">
              <div class="progress-fill" style="width: ${getTotalTasksCount() > 0 ? (getCompletedTasksCount() / getTotalTasksCount() * 100) : 0}%;"></div>
            </div>
            <p style="color: var(--muted); font-size: 14px;">${getTotalTasksCount() > 0 ? Math.round(getCompletedTasksCount() / getTotalTasksCount() * 100) : 0}% of all tasks completed</p>
          </div>
        </div>
      `,
      
      goals: () => `
        <div>
          <div style="margin-bottom: 32px;">
            <h2 class="text-3xl font-extrabold">Goals</h2>
            <p class="text-lg" style="color: var(--muted); margin-top: 8px;">Set and track your study goals</p>
          </div>
          
          <div class="card" style="padding: 24px; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
              <h3 class="text-xl font-bold">My Goals</h3>
              <button class="btn btn-primary" style="padding: 10px 20px; font-size: 14px;" onclick="openModal('goalModal')">
                <i data-lucide="plus" class="w-4 h-4" style="display: inline-block; vertical-align: middle;"></i>
                <span style="vertical-align: middle; margin-left: 4px;">New Goal</span>
              </button>
            </div>
            <div id="goalList"></div>
          </div>
        </div>
      `,
      
      settings: () => `
        <div>
          <div style="margin-bottom: 32px;">
            <h2 class="text-3xl font-extrabold">Settings</h2>
            <p class="text-lg" style="color: var(--muted); margin-top: 8px;">Manage your preferences</p>
          </div>
          
          <div class="card" style="padding: 32px; max-width: 800px; margin-bottom: 24px;">
            <h3 class="text-xl font-bold" style="margin-bottom: 16px;">Account</h3>
            <p style="color: var(--muted); margin-bottom: 12px;">Logged in as: <strong>${currentUser ? currentUser.email : 'Not logged in'}</strong></p>
            <button class="btn btn-danger" style="padding: 12px 20px;" onclick="handleLogout()">
              <i data-lucide="log-out" class="w-4 h-4" style="display: inline-block; vertical-align: middle;"></i>
              <span style="vertical-align: middle; margin-left: 4px;">Log Out</span>
            </button>
          </div>
          
          <div class="card" style="padding: 32px; max-width: 800px;">
            <h3 class="text-xl font-bold" style="margin-bottom: 16px;">Data Management</h3>
            <p style="color: var(--muted); margin-bottom: 20px;">Your data is synced across all your devices via Firebase.</p>
            
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <button class="btn btn-danger" style="padding: 12px 20px;" onclick="clearAllData()">
                <i data-lucide="trash-2" class="w-4 h-4" style="display: inline-block; vertical-align: middle;"></i>
                <span style="vertical-align: middle; margin-left: 4px;">Clear All Data</span>
              </button>
              <button class="btn btn-secondary" style="padding: 12px 20px;" onclick="exportData()">
                <i data-lucide="download" class="w-4 h-4" style="display: inline-block; vertical-align: middle;"></i>
                <span style="vertical-align: middle; margin-left: 4px;">Export Data</span>
              </button>
            </div>
            
            <div style="margin-top: 32px; padding-top: 32px; border-top: 1px solid var(--border);">
              <h3 class="text-xl font-bold" style="margin-bottom: 16px;">Statistics</h3>
              <div style="display: grid; gap: 12px;">
                <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.04); border-radius: 8px;">
                  <span style="color: var(--muted);">Total Tasks</span>
                  <span style="font-weight: 700;">${getTotalTasksCount()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.04); border-radius: 8px;">
                  <span style="color: var(--muted);">Total Exams</span>
                  <span style="font-weight: 700;">${state.exams.length}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.04); border-radius: 8px;">
                  <span style="color: var(--muted);">Total Goals</span>
                  <span style="font-weight: 700;">${state.goals.length}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `
    };
    
    // Navigation
    function navigate(pageName) {
      state.currentPage = pageName;
      const pageContent = pages[pageName]();
      document.getElementById('mainContent').innerHTML = pageContent;
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === pageName);
      });
      renderTasks();
      renderExams();
      renderUpcomingExams();
      renderGoals();
      updateTimer();
      lucide.createIcons();
    }
    
    // Task Management
    function renderTasks() {
      const taskList = document.getElementById('taskList');
      if (!taskList) return;
      
      if (state.tasks.length === 0) {
        taskList.innerHTML = `
          <div class="empty-state">
            <i data-lucide="clipboard" style="margin: 0 auto;"></i>
            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No tasks yet</h4>
            <p style="font-size: 14px;">Click "Add Task" to create your first task</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }
      
      taskList.innerHTML = state.tasks.map(task => `
        <div class="task-item ${task.completed ? 'completed' : ''}">
          <div class="checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
            ${task.completed ? '<i data-lucide="check" class="w-3 h-3" style="color: white;"></i>' : ''}
          </div>
          <div style="flex: 1;">
            <div class="task-text" style="font-weight: 500;">${task.title}</div>
            <div style="display: flex; gap: 8px; margin-top: 6px; align-items: center;">
              <span class="badge subject-${task.subject.toLowerCase()}">${task.subject}</span>
              <span style="color: var(--muted-2); font-size: 12px;">Due: ${formatDateTime(task.due)}</span>
            </div>
          </div>
          <button class="delete-btn" onclick="deleteTask(${task.id})">
            <i data-lucide="trash-2" class="w-3 h-3"></i>
          </button>
        </div>
      `).join('');
      
      lucide.createIcons();
    }
    
    function toggleTask(taskId) {
      const task = state.tasks.find(t => t.id === taskId);
      if (task) {
        task.completed = !task.completed;
        saveState();
        renderTasks();
        if (task.completed) {
          confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
        }
        navigate(state.currentPage);
      }
    }
    
    function deleteTask(taskId) {
      if (confirm('Are you sure you want to delete this task?')) {
        state.tasks = state.tasks.filter(t => t.id !== taskId);
        saveState();
        navigate(state.currentPage);
      }
    }
    
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    function saveTask() {
      const title = sanitizeInput(document.getElementById('taskTitle').value.trim());
      const subject = sanitizeInput(document.getElementById('taskSubject').value);
      const due = document.getElementById('taskDue').value;
      
      if (!title || !subject || !due) {
        alert('Please fill in all required fields');
        return;
      }
      
      if (title.length > 500) {
        alert('Task title is too long (max 500 characters)');
        return;
      }
      
      const newTask = {
        id: Date.now(),
        title,
        subject,
        due,
        completed: false
      };
      
      if (!validateTaskData({text: title})) {
        alert('Invalid task data');
        return;
      }
      
      state.tasks.push(newTask);
      saveState();
      navigate(state.currentPage);
      closeModal('taskModal');
      document.getElementById('taskTitle').value = '';
      document.getElementById('taskDue').value = '';
      confetti({ particleCount: 100, spread: 70 });
      } else {
        alert('Please fill in all fields');
      }
    }
    
    // Exam Management
    function renderExams() {
      const examList = document.getElementById('examList');
      if (!examList) return;
      
      if (state.exams.length === 0) {
        examList.innerHTML = `
          <div class="empty-state">
            <i data-lucide="calendar" style="margin: 0 auto;"></i>
            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No exams scheduled</h4>
            <p style="font-size: 14px;">Click "Add Exam" to schedule your first exam</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }
      
      const sortedExams = [...state.exams].sort((a, b) => new Date(a.date) - new Date(b.date));
      
      examList.innerHTML = sortedExams.map(exam => {
        const examDate = new Date(exam.date);
        const now = new Date();
        const isPast = examDate < now;
        
        return `
          <div style="display: flex; gap: 16px; padding: 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 12px; ${isPast ? 'opacity: 0.5;' : ''}">
            <div style="background: rgba(${exam.subject === 'Math' ? '239, 68, 68' : exam.subject === 'Science' ? '34, 197, 94' : exam.subject === 'English' ? '59, 130, 246' : '251, 191, 36'}, 0.15); border: 1px solid rgba(${exam.subject === 'Math' ? '239, 68, 68' : exam.subject === 'Science' ? '34, 197, 94' : exam.subject === 'English' ? '59, 130, 246' : '251, 191, 36'}, 0.3); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 60px;">
              <div style="font-size: 24px; font-weight: 800;">${examDate.getDate()}</div>
              <div style="font-size: 12px; color: var(--muted);">${examDate.toLocaleString('default', { month: 'short' }).toUpperCase()}</div>
            </div>
            <div style="flex: 1;">
              <span class="badge subject-${exam.subject.toLowerCase()}">${exam.subject}</span>
              <h4 style="font-weight: 700; font-size: 16px; margin-top: 8px;">${exam.name}</h4>
              ${exam.notes ? `<p style="color: var(--muted); font-size: 13px; margin-top: 4px;">${exam.notes}</p>` : ''}
              <p style="color: var(--muted-2); font-size: 12px; margin-top: 4px;">${examDate.toLocaleString()}</p>
            </div>
            <div style="display: flex; align-items: start;">
              <button class="delete-btn" onclick="deleteExam(${exam.id})">
                <i data-lucide="trash-2" class="w-3 h-3"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      lucide.createIcons();
    }
    
    function renderUpcomingExams() {
      const container = document.getElementById('upcomingExams');
      if (!container) return;
      
      const upcoming = getUpcomingExams();
      
      if (upcoming.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--muted-2); font-size: 13px;">
            No upcoming exams
          </div>
        `;
        return;
      }
      
      container.innerHTML = upcoming.map(exam => {
        const daysUntil = Math.floor((new Date(exam.date) - new Date()) / (1000 * 60 * 60 * 24));
        const urgency = daysUntil <= 2 ? 'danger' : daysUntil <= 7 ? 'warning' : 'primary';
        const color = urgency === 'danger' ? '239, 68, 68' : urgency === 'warning' ? '251,191,36' : '99,102,241';
        
        return `
          <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(${color},0.1); border: 1px solid rgba(${color},0.2); border-radius: 12px; margin-bottom: 8px;">
            <i data-lucide="alert-circle" class="w-5 h-5" style="flex-shrink: 0;"></i>
            <div>
              <div style="font-weight: 600; font-size: 14px;">${exam.name}</div>
              <div style="color: var(--muted-2); font-size: 12px;">${formatDateTime(exam.date)}</div>
            </div>
          </div>
        `;
      }).join('');
      
      lucide.createIcons();
    }
    
    function saveExam() {
      const name = sanitizeInput(document.getElementById('examName').value.trim());
      const subject = sanitizeInput(document.getElementById('examSubject').value);
      const date = document.getElementById('examDate').value;
      const notes = sanitizeInput(document.getElementById('examNotes').value.trim());
      
      if (!name || !subject || !date) {
        alert('Please fill in all required fields');
        return;
      }
      
      const newExam = {
        id: Date.now(),
        name,
        subject,
        date,
        notes
      };
      
      if (!validateExamData(newExam)) {
        alert('Invalid exam data. Please check your inputs.');
        return;
      }
      
      state.exams.push(newExam);
      saveState();
      navigate(state.currentPage);
      closeModal('examModal');
      document.getElementById('examName').value = '';
      document.getElementById('examDate').value = '';
      document.getElementById('examNotes').value = '';
      confetti({ particleCount: 100, spread: 70 });
      } else {
        alert('Please fill in all required fields');
      }
    }
    
    function deleteExam(examId) {
      if (confirm('Are you sure you want to delete this exam?')) {
        state.exams = state.exams.filter(e => e.id !== examId);
        saveState();
        navigate(state.currentPage);
      }
    }
    
    // Goal Management
    function renderGoals() {
      const goalList = document.getElementById('goalList');
      if (!goalList) return;
      
      if (state.goals.length === 0) {
        goalList.innerHTML = `
          <div class="empty-state">
            <i data-lucide="target" style="margin: 0 auto;"></i>
            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No goals yet</h4>
            <p style="font-size: 14px;">Click "New Goal" to create your first goal</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }
      
      goalList.innerHTML = state.goals.map(goal => `
        <div style="padding: 20px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <div style="flex: 1;">
              <h4 style="font-weight: 700; font-size: 18px;">${goal.title}</h4>
              <span class="badge" style="margin-top: 8px; display: inline-block;">${goal.category}</span>
            </div>
            <button class="delete-btn" onclick="deleteGoal(${goal.id})">
              <i data-lucide="trash-2" class="w-3 h-3"></i>
            </button>
          </div>
          ${goal.description ? `<p style="color: var(--muted); font-size: 14px; margin-bottom: 12px;">${goal.description}</p>` : ''}
          <div style="display: flex; align-items: center; gap: 8px; color: var(--muted-2); font-size: 13px;">
            <i data-lucide="calendar" class="w-4 h-4"></i>
            <span>Target: ${new Date(goal.target).toLocaleDateString()}</span>
          </div>
        </div>
      `).join('');
      
      lucide.createIcons();
    }
    
    function saveGoal() {
      const title = sanitizeInput(document.getElementById('goalTitle').value.trim());
      const category = sanitizeInput(document.getElementById('goalCategory').value);
      const target = document.getElementById('goalTarget').value;
      const description = sanitizeInput(document.getElementById('goalDescription').value.trim());
      
      if (!title || !category || !target) {
        alert('Please fill in all required fields');
        return;
      }
      
      const newGoal = {
        id: Date.now(),
        title,
        category,
        target,
        description
      };
      
      if (!validateGoalData(newGoal)) {
        alert('Invalid goal data. Please check your inputs.');
        return;
      }
      
      state.goals.push(newGoal);
      saveState();
      navigate(state.currentPage);
      closeModal('goalModal');
      document.getElementById('goalTitle').value = '';
      document.getElementById('goalTarget').value = '';
      document.getElementById('goalDescription').value = '';
      confetti({ particleCount: 100, spread: 70 });
      } else {
        alert('Please fill in all required fields');
      }
    }
    
    function deleteGoal(goalId) {
      if (confirm('Are you sure you want to delete this goal?')) {
        state.goals = state.goals.filter(g => g.id !== goalId);
        saveState();
        navigate(state.currentPage);
      }
    }
    
    // Timer Functions
    let timerStartMinutes = 25; // Track the initial timer value
    
    function toggleTimer() {
      if (state.timer.isRunning) {
        clearInterval(state.timer.interval);
        state.timer.isRunning = false;
        updateTimerButton('play', 'Start');
      } else {
        timerStartMinutes = state.timer.minutes; // Remember start time
        state.timer.isRunning = true;
        state.timer.interval = setInterval(() => {
          if (state.timer.seconds === 0) {
            if (state.timer.minutes === 0) {
              clearInterval(state.timer.interval);
              state.timer.isRunning = false;
              
              // Add the actual study time
              state.studyTime += timerStartMinutes;
              
              // Update streak
              updateStreak();
              
              saveState();
              confetti({ particleCount: 200, spread: 100 });
              updateTimerButton('play', 'Start');
              navigate(state.currentPage);
              return;
            }
            state.timer.minutes--;
            state.timer.seconds = 59;
          } else {
            state.timer.seconds--;
          }
          updateTimer();
        }, 1000);
        
        updateTimerButton('pause', 'Pause');
      }
    }
    
    function updateTimerButton(icon, text) {
      const btns = document.querySelectorAll('#startTimer');
      btns.forEach(btn => {
        if (btn) {
          btn.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4" style="display: inline-block; vertical-align: middle;"></i><span style="vertical-align: middle; margin-left: 4px;">${text}</span>`;
        }
      });
      lucide.createIcons();
    }
    
    function resetTimer() {
      clearInterval(state.timer.interval);
      state.timer.isRunning = false;
      state.timer.minutes = 25;
      state.timer.seconds = 0;
      updateTimer();
      updateTimerButton('play', 'Start');
    }
    
    function setTimer(minutes) {
      clearInterval(state.timer.interval);
      state.timer.isRunning = false;
      state.timer.minutes = minutes;
      state.timer.seconds = 0;
      updateTimer();
      updateTimerButton('play', 'Start');
    }
    
    function updateTimer() {
      const display = `${String(state.timer.minutes).padStart(2, '0')}:${String(state.timer.seconds).padStart(2, '0')}`;
      const els = document.querySelectorAll('[id^="timerDisplay"]');
      els.forEach(el => {
        if (el) el.textContent = display;
      });
    }
    
    function openCustomTimer() {
      openModal('customTimerModal');
    }
    
    function setCustomTimer() {
      const minutes = parseInt(document.getElementById('customMinutes').value);
      if (minutes && minutes > 0 && minutes <= 180) {
        setTimer(minutes);
        closeModal('customTimerModal');
      } else {
        alert('Please enter a valid time between 1 and 180 minutes');
      }
    }
    
    // Streak Management
    function updateStreak() {
      const today = new Date().toDateString();
      
      if (!state.lastStudyDate) {
        // First time studying
        state.streak = 1;
        state.lastStudyDate = today;
      } else if (state.lastStudyDate === today) {
        // Already studied today, keep streak
        return;
      } else {
        const lastDate = new Date(state.lastStudyDate);
        const currentDate = new Date(today);
        const diffTime = Math.abs(currentDate - lastDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) {
          // Consecutive day, increment streak
          state.streak++;
        } else if (diffDays > 1) {
          // Streak broken, reset to 1
          state.streak = 1;
        }
        
        state.lastStudyDate = today;
      }
    }
    
    function checkStreak() {
      if (!state.lastStudyDate) return;
      
      const today = new Date().toDateString();
      const lastDate = new Date(state.lastStudyDate);
      const currentDate = new Date(today);
      const diffTime = Math.abs(currentDate - lastDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      // If more than 1 day has passed, reset streak
      if (diffDays > 1) {
        state.streak = 0;
        saveState();
      }
    }
    
    // Settings Functions
    function clearAllData() {
      if (confirm('Are you sure you want to clear all data? This cannot be undone and will sync across all devices!')) {
        state.tasks = [];
        state.exams = [];
        state.goals = [];
        state.studyTime = 0;
        state.streak = 0;
        state.lastStudyDate = null;
        saveState(); // This will sync to Firebase
        navigate('dashboard');
        alert('All data cleared!');
      }
    }
    
    function exportData() {
      const data = {
        tasks: state.tasks,
        exams: state.exams,
        goals: state.goals,
        studyTime: state.studyTime,
        streak: state.streak,
        exportedAt: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `studypilot-backup-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.addEventListener('click', () => navigate(item.dataset.page));
      });
      
      // Close modals when clicking outside
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('active');
          }
        });
      });
      
      // Don't navigate until user is authenticated
      // navigate('dashboard');
      lucide.createIcons();
    });
  </script>
</body>
</html>
